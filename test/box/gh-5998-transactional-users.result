-- test-run result file version 2
env = require('test_run')
 | ---
 | ...
test_run = env.new()
 | ---
 | ...
test_run:cmd("create server tx_man with script='box/tx_man.lua'")
 | ---
 | - true
 | ...
test_run:cmd("start server tx_man")
 | ---
 | - true
 | ...
test_run:cmd("switch tx_man")
 | ---
 | - true
 | ...

txn_proxy = require('txn_proxy')
 | ---
 | ...
map = {x = 3}
 | ---
 | ...

-- Firstly, let's test that in scope of one transaction all
-- invocations to users are trully transactional.
--
tx1 = txn_proxy.new()
 | ---
 | ...

-- Insert-Delete-Commit
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1:commit()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - []
 | ...

-- Insert-Delete-Rollback
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1:rollback()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - []
 | ...
box.space._user:insert({35, 1, 'asd', 'user', map})
 | ---
 | - [35, 1, 'asd', 'user', {'x': 3}]
 | ...

-- Delete-Insert-Rollback
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:insert({35, 1, 'dsa', 'user', map})")
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
tx1:rollback()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...

-- Delete-Insert-Commit
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:insert({35, 1, 'dsa', 'user', map})")
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
tx1:commit()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
box.space._user:delete({35})
 | ---
 | - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...

-- Insert-Replace-Rollback
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:replace({35, 1, 'dsa', 'user', map})")
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
tx1:rollback()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - []
 | ...

-- Insert-Replace-Commit
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:replace({35, 1, 'dsa', 'user', map})")
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
tx1:commit()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...

-- Replace-Delete-Rollback
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:replace({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1:rollback()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...

-- Replace-Delete-Commit
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:replace({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1:commit()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - []
 | ...

-- Insert-Delete-Insert-Commit
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:insert({35, 1, 'dsa', 'user', map})")
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
tx1:commit()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
box.space._user:delete({35})
 | ---
 | - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...

-- Insert-Delete-Insert-Rollback
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:insert({35, 1, 'dsa', 'user', map})")
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
tx1:rollback()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - []
 | ...

-- Insert-Delete-Insert-Commit
tx1:begin()
 | ---
 | - 
 | ...
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:delete({35})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx1("box.space._user:insert({35, 1, 'dsa', 'user', map})")
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
tx1:commit()
 | ---
 | - 
 | ...

box.space._user:select({35})
 | ---
 | - - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...
box.space._user:delete({35})
 | ---
 | - [35, 1, 'dsa', 'user', {'x': 3}]
 | ...

-- Then let's test that several transactions can operate on
-- _user at the same time.
--
tx2 = txn_proxy.new()
 | ---
 | ...

tx1:begin()
 | ---
 | - 
 | ...
tx2:begin()
 | ---
 | - 
 | ...

-- Parallel insert.
--
tx1("box.space._user:insert({35, 1, 'asd', 'user', map})")
 | ---
 | - - [35, 1, 'asd', 'user', {'x': 3}]
 | ...
tx2("box.space._user:insert({35, 1, 'dsa', 'user', map})")
 | ---
 | - - {'error': 'Can''t modify user: another transaction has already acquired it'}
 | ...
tx2("box.space._user:insert({35, 1, 'dsa', 'user', map})")
 | ---
 | - - {'error': 'Can''t modify user: another transaction has already acquired it'}
 | ...
tx2("box.space._user:select({35})")
 | ---
 | - - []
 | ...
tx1("box.space._user:select({35})")
 | ---
 | - - [[35, 1, 'asd', 'user', {'x': 3}]]
 | ...

tx1:commit()
 | ---
 | - 
 | ...
tx2:commit()
 | ---
 | - 
 | ...

box.space._user:delete({35})
 | ---
 | - [35, 1, 'asd', 'user', {'x': 3}]
 | ...

box.space._user:select({35})
 | ---
 | - []
 | ...
box.space._user:delete({35})
 | ---
 | ...

-- Original test case which led to crash due to wrong on_rollback trigger.
--
tx1:begin()
 | ---
 | - 
 | ...
tx2:begin()
 | ---
 | - 
 | ...

tx1("box.schema.user.create('internal1')")
 | ---
 | - 
 | ...
tx2("box.schema.user.create('internal2')")
 | ---
 | - - {'error': 'Can''t modify user: another transaction has already acquired it'}
 | ...

tx1:commit()
 | ---
 | - 
 | ...
tx2:commit()
 | ---
 | - 
 | ...

box.schema.user.drop('internal1')
 | ---
 | ...

-- Still lock works only on write operations on _user. Let's setup user and
-- read its entry from cache while checking access on any write operation --
-- this will work (however intuitively it shouldn't).
--
box.schema.user.create('test')
 | ---
 | ...
box.schema.user.grant('test', 'write', 'space', '_space')
 | ---
 | ...

tx1:begin()
 | ---
 | - 
 | ...
tx2:begin()
 | ---
 | - 
 | ...
tx1("box.schema.user.revoke('test', 'write', 'space', '_space')")
 | ---
 | - 
 | ...
tx2("box.session.su('test')")
 | ---
 | - 
 | ...
tx2("box.schema.create_space('t1')")
 | ---
 | - - {'error': 'Write access to space ''_schema'' is denied for user ''test'''}
 | ...

tx1:rollback()
 | ---
 | - 
 | ...
tx2:rollback()
 | ---
 | - 
 | ...

box.schema.user.drop('test')
 | ---
 | ...

-- Check that write operations on _user blocks other txs to read modified user.
--
tx1:begin()
 | ---
 | - 
 | ...
tx2:begin()
 | ---
 | - 
 | ...
tx1("box.schema.user.create('test')")
 | ---
 | - 
 | ...
tx2("box.session.su('test')")
 | ---
 | - - {'error': 'User ''test'' is not found'}
 | ...
tx2("box.schema.user.grant('test', 'write', 'space', '_space')")
 | ---
 | - - {'error': 'Can''t modify user: another transaction has already acquired it'}
 | ...

tx1:rollback()
 | ---
 | - 
 | ...
tx2:rollback()
 | ---
 | - 
 | ...

test_run:cmd("switch default")
 | ---
 | - true
 | ...
test_run:cmd("stop server tx_man")
 | ---
 | - true
 | ...
test_run:cmd("cleanup server tx_man")
 | ---
 | - true
 | ...
